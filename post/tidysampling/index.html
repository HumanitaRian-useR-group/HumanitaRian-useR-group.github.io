<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Working with Survey Samples in the Tidyverse</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.74.3" />
        


        
            <meta name="author" content="Hisham Galal">
        
        
            
                <meta name="description" content="The humanitarian data analysis professional community shall work towards using a common and open language to build interoperable and transparent analysis standards for joint needs assessments and to obtain maximum value for any data collected.">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Working with Survey Samples in the Tidyverse"/>
<meta name="twitter:description" content="Despite the growing interest in Big Data and alternative data sources, household surveys remain the gold-standard for the production of official statistics. It should then come as no surprise that a diverse selection of packages have been developed to facilitate working with survey data in R.  # Introduction Two of the most popular packages in this regard are sampling and survey for drawing survey samples and point/variance estimation, respectively, under complex sample designs."/>

        <meta property="og:title" content="Working with Survey Samples in the Tidyverse" />
<meta property="og:description" content="Despite the growing interest in Big Data and alternative data sources, household surveys remain the gold-standard for the production of official statistics. It should then come as no surprise that a diverse selection of packages have been developed to facilitate working with survey data in R.  # Introduction Two of the most popular packages in this regard are sampling and survey for drawing survey samples and point/variance estimation, respectively, under complex sample designs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/tidysampling/" />
<meta property="article:published_time" content="2020-05-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-29T00:00:00+00:00" />

        <meta property="og:image" content="//images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        <meta itemprop="name" content="Working with Survey Samples in the Tidyverse">
<meta itemprop="description" content="Despite the growing interest in Big Data and alternative data sources, household surveys remain the gold-standard for the production of official statistics. It should then come as no surprise that a diverse selection of packages have been developed to facilitate working with survey data in R.  # Introduction Two of the most popular packages in this regard are sampling and survey for drawing survey samples and point/variance estimation, respectively, under complex sample designs.">
<meta itemprop="datePublished" content="2020-05-29T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-05-29T00:00:00+00:00" />
<meta itemprop="wordCount" content="2567">



<meta itemprop="keywords" content="UNHCR,Hisham-Galal," />

        

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/add-on.css">
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
        


  
    
    <link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />
  


      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-131350181-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

      
            <script
			  src="http://code.jquery.com/jquery-3.3.1.min.js"
			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous"></script>
			  
    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      
        <h1><a href="/">post</a></h1>
      
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/post/index.html">
                            <i class="fa fa-home">&nbsp;</i>Home
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                            <i class="fa fa-info-circle">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/tags/">
                            <i class="fa fa-newspaper-o">&nbsp;</i>Contributors
                    </a>
                </li>
            
                <li>
                    <a href="/categories/">
                            <i class="fa fa-database">&nbsp;</i>Categories
                    </a>
                </li>
            
                <li>
                    <a href="https://join.skype.com/qYBKC5q3wKp4">
                            <i class="fa fa-phone">&nbsp;</i>Join the Skype-group
                    </a>
                </li>
            
                <li>
                    <a href="https://www.r-bloggers.com/">
                            <i class="fa fa-universal-access">&nbsp;</i>learn more with R-bloggers
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/post/index.html">
                            <h3>
                                <i class="fa fa-home">&nbsp;</i>Home
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                <i class="fa fa-info-circle">&nbsp;</i>About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/">
                            <h3>
                                <i class="fa fa-newspaper-o">&nbsp;</i>Contributors
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories/">
                            <h3>
                                <i class="fa fa-database">&nbsp;</i>Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="https://join.skype.com/qYBKC5q3wKp4">
                            <h3>
                                <i class="fa fa-phone">&nbsp;</i>Join the Skype-group
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="https://www.r-bloggers.com/">
                            <h3>
                                <i class="fa fa-universal-access">&nbsp;</i>learn more with R-bloggers
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section class="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/anonymisation/">Anonymisation: Intrusion scenario and risk threshold</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-06-25'>
                                    June 25, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/">Post</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-06-25'>
                                    June 25, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/tidysampling/">Working with Survey Samples in the Tidyverse</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-05-29'>
                                    May 29, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/geosampling/">Using Gridded Population Data for Household Survey Sampling</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-04-14'>
                                    April 14, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/quick-tips-for-visualising-data/">Quick tips for visualising data (with R)</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-04-02'>
                                    April 2, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/conjoint-analysis/">Conjoint analysis: modeling judgement to calibrate vulnerability scoring</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-03-19'>
                                    March 19, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/analytic-hierachy-process/">Using Analytic Hierarchy Process to weight vulnerability scorecard</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-02-23'>
                                    February 23, 2020</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /post/
                        
                        class="button">See more</a>
                
            </div>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            



<li>
  <a href="//twitter.com/share?url=%2fpost%2ftidysampling%2f&amp;text=Working%20with%20Survey%20Samples%20in%20the%20Tidyverse&amp;via=" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>




<li>
  <a href="//plus.google.com/share?url=%2fpost%2ftidysampling%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>





<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fpost%2ftidysampling%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>




<li>
  <a href="//reddit.com/submit?url=%2fpost%2ftidysampling%2f&amp;title=Working%20with%20Survey%20Samples%20in%20the%20Tidyverse" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>




<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fpost%2ftidysampling%2f&amp;title=Working%20with%20Survey%20Samples%20in%20the%20Tidyverse" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>




<li>
  <a href="//www.stumbleupon.com/submit?url=%2fpost%2ftidysampling%2f&amp;title=Working%20with%20Survey%20Samples%20in%20the%20Tidyverse" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>




<li>
  <a href="//www.pinterest.com/pin/create/button/?url=%2fpost%2ftidysampling%2f&amp;description=Working%20with%20Survey%20Samples%20in%20the%20Tidyverse" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>




<li>
  <a href="mailto:?subject=Check out this post by Hisham%20Galal&amp;body=%2fpost%2ftidysampling%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>


        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
  <header>
    <div class="title">
        
            <h1><a href="/post/tidysampling/">Working with Survey Samples in the Tidyverse</a></h1>
            
        
        
    </div>
    <div class="meta">
        <time class="published"
            datetime='2020-05-29 00:00:00 &#43;0000 UTC'>
            May 29, 2020</time>
        <span class="author">Hisham Galal</span>
        
            <p>13 minutes read</p>
        
    </div>
</header>


  

  

  
  <div>
     
 <div id="go-to-folding-div" style="display: inline-block;vertical-align: top;height: 1px;margin-top: -4em;"></div>
 <div id="code-folding-buttons" class="btn-group pull-right">
   <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast="">
     <span>Show/Hide all code</span> 
     <span class="caret"></span>
   </button>
   <ul class="dropdown-menu" style="min-width: 50px;">
   <li><a id="rmd-show-all-code" href="#go-to-folding-div">Show All Code</a>
   </li><li><a id="rmd-hide-all-code" href="#go-to-folding-div">Hide All Code</a></li>
   </ul>
 </div>
 

    <br/>
    <div id="content" class="article-entry">
      


<p>Despite the growing interest in Big Data and alternative data sources, household surveys remain the gold-standard for the production of official statistics. It should then come as no surprise that <a href="https://cran.r-project.org/web/views/OfficialStatistics.html">a diverse selection of packages</a> have been developed to facilitate working with survey data in R.
<!--MORE-->
# Introduction
Two of the most popular packages in this regard are <a href="https://cran.r-project.org/package=sampling">sampling</a> and <a href="https://cran.r-project.org/package=survey">survey</a> for drawing survey samples and point/variance estimation, respectively, under complex sample designs. Yet, while both packages are part of the standard survey analyst’s toolbox, they are not the most user-friendly packages to work with (especially survey) but that is by no fault of their own. Both packages offer a bewildering array of options meant to support even the most arcane of survey techniques and it’s not easy to encapsulate the underlying complexity of all those methods behind a simple interface. Another issue with those packages is that they don’t fit neatly into tidy workflows though recent work on <a href="https://cran.r-project.org/package=srvyr">srvyr</a> is trying to remedy that.</p>
<p>Our aim in this brief tutorial is to illustrate how the most common sample designs and estimation procedures can be carried out with little more than basic dplyr verbs. The sampling approach presented here was inspired by <a href="https://jennybc.github.io/purrr-tutorial/ls12_different-sized-samples.html">this post</a> by Jennifer Bryan.</p>
<p>Let’s first start by constructing a synthetic census dataset to serve as our sampling frame.</p>
<pre class="r"><code>library(tidyverse)
library(fabricatr)

set.seed(1)

refpop &lt;- 
  fabricate(
    ea = add_level(333),
    hh = 
      add_level(
        N = round(rnorm(length(ea), 100, 25)),
        safety = c(&quot;Not safe&quot;, &quot;Safe&quot;)[1+draw_binary_icc(clusters = ea, prob = .4, ICC = .1)],
        pcexp = draw_normal_icc(clusters = ea, mean = 5000, sd = 1000, ICC = .1)))

hcpop &lt;- 
  fabricate(
    ea = add_level(667),
    hh = 
      add_level(
        N = round(rnorm(length(ea), 100, 25)),
        safety = c(&quot;Not safe&quot;, &quot;Safe&quot;)[1+draw_binary_icc(prob = .7, clusters = ea, ICC = .1)],
        pcexp = draw_normal_icc(clusters = ea, mean = 10000, sd = 1500, ICC = .1)))

universe &lt;- 
  bind_rows(&quot;Refugees&quot; = refpop, &quot;Host community&quot; = hcpop, .id = &quot;strata&quot;) %&gt;% 
  as_tibble()</code></pre>
<p>That’s a population of about 100,000 households that is one-third refugees and two-thirds host community members (think of a small refugee camp and its neighboring villages). The population has been divided into enumeration areas with an average of 100 households each and we have two indicators on our synthetic population: <code>safety</code>, a binary indicator of whether the household feels safe or not in their neighborhood, and <code>pcexp</code> for an estimate of household per-capita expenditure. Both measures exhibit some degree of clustering as would be expected.</p>
<p>Here’s what the data looks like:</p>
<pre class="r"><code>universe %&gt;% head(10)</code></pre>
<pre><code>## # A tibble: 10 x 5
##    strata   ea    hh    safety   pcexp
##    &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
##  1 Refugees 001   00001 Safe     4447.
##  2 Refugees 001   00002 Not safe 4537.
##  3 Refugees 001   00003 Safe     3581.
##  4 Refugees 001   00004 Safe     5272.
##  5 Refugees 001   00005 Safe     5008.
##  6 Refugees 001   00006 Safe     7176.
##  7 Refugees 001   00007 Safe     6766.
##  8 Refugees 001   00008 Not safe 5269.
##  9 Refugees 001   00009 Safe     5631.
## 10 Refugees 001   00010 Safe     5308.</code></pre>
<div id="quick-aside-nested-tables" class="section level1">
<h1>Quick Aside: Nested Tables</h1>
<p>What makes dplyr especially useful for working with survey samples is its support for nested tables. Table nesting comes in handy whenever you’re working with hierarchical data and want to run operations on entities at different levels of the hierarchy. The trick that allows this is that tables in R are just lists of equal-length items that store column values, but since lists can store any data type, including other lists, we can store entire tables in table cells.</p>
<p>The following is a perfectly valid data.frame in R:</p>
<pre class="r"><code>(ex &lt;- 
   tribble(
     ~parent, ~children,
     &quot;10s&quot;,  tibble(x = 10:19),
     &quot;20s&quot;,  tibble(x = 20:29),
     &quot;30s&quot;,  tibble(x = 30:39)))</code></pre>
<pre><code>## # A tibble: 3 x 2
##   parent children         
##   &lt;chr&gt;  &lt;list&gt;           
## 1 10s    &lt;tibble [10 × 1]&gt;
## 2 20s    &lt;tibble [10 × 1]&gt;
## 3 30s    &lt;tibble [10 × 1]&gt;</code></pre>
<p>And dplyr’s nest()/unnest() functions do all the hard-work of packing/unpacking data to allow us to move up and down the grouping hierarchy.</p>
<p>Unnesting moves us down:</p>
<pre class="r"><code>(tmp &lt;- ex %&gt;% unnest(children))</code></pre>
<pre><code>## # A tibble: 30 x 2
##    parent     x
##    &lt;chr&gt;  &lt;int&gt;
##  1 10s       10
##  2 10s       11
##  3 10s       12
##  4 10s       13
##  5 10s       14
##  6 10s       15
##  7 10s       16
##  8 10s       17
##  9 10s       18
## 10 10s       19
## # … with 20 more rows</code></pre>
<p>While nesting takes us up:</p>
<pre class="r"><code>tmp %&gt;% group_nest(parent)</code></pre>
<pre><code>## # A tibble: 3 x 2
##   parent               data
##   &lt;chr&gt;  &lt;list&lt;tbl_df[,1]&gt;&gt;
## 1 10s              [10 × 1]
## 2 20s              [10 × 1]
## 3 30s              [10 × 1]</code></pre>
<p>It should be easy to see how this could help when working with nested populations.</p>
</div>
<div id="sampling" class="section level1">
<h1>Sampling</h1>
<p>We’re now ready to dive into sampling.</p>
<div id="simple-random-sampling" class="section level2">
<h2>Simple Random Sampling</h2>
<p>Simple random sampling is the cornerstone foundation of all sample designs. It’s implemented in dplyr using <code>sample_n()</code>. Here’s a draw of 1000 households:</p>
<pre class="r"><code>universe %&gt;% sample_n(size = 1000)</code></pre>
<pre><code>## # A tibble: 1,000 x 5
##    strata         ea    hh    safety    pcexp
##    &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 Host community 128   12486 Safe     11196.
##  2 Host community 308   30522 Safe      5842.
##  3 Refugees       264   26485 Not safe  3529.
##  4 Host community 625   62127 Not safe  8179.
##  5 Host community 667   66311 Safe      9265.
##  6 Host community 259   25738 Safe     10715.
##  7 Host community 354   34970 Safe     11805.
##  8 Host community 172   16941 Safe      6745.
##  9 Host community 130   12736 Safe      9834.
## 10 Host community 476   47157 Safe     10941.
## # … with 990 more rows</code></pre>
</div>
<div id="stratified-sampling" class="section level2">
<h2>Stratified Sampling</h2>
<p>On to a slightly more sophisticated sample design. The beauty of dplyr is that it allows you to express in code the same exact steps you would follow when describing the method:</p>
<pre class="r"><code>universe %&gt;% 
  # partition the population into strata
  group_nest(strata) %&gt;% 
  # for each stratum...
  rowwise() %&gt;% 
  mutate(
    # calculate the required sample size
    samplesz = round(1000*nrow(data)/nrow(universe)),
    # then draw the sample
    sample = list(sample_n(data, size = samplesz))) %&gt;% 
  select(-c(data, samplesz)) %&gt;% 
  # et voila!
  unnest(sample)</code></pre>
<pre><code>## # A tibble: 1,000 x 5
##    strata         ea    hh    safety    pcexp
##    &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 Host community 628   62409 Not safe 12276.
##  2 Host community 110   10667 Not safe  7144.
##  3 Host community 455   44932 Safe      9399.
##  4 Host community 125   12189 Not safe  7934.
##  5 Host community 584   57910 Safe      9732.
##  6 Host community 301   29859 Safe      9707.
##  7 Host community 455   44944 Safe      6846.
##  8 Host community 309   30631 Not safe  9303.
##  9 Host community 100   09825 Safe      8350.
## 10 Host community 289   28624 Safe      7961.
## # … with 990 more rows</code></pre>
<p>That’s it for stratified sampling! For disproportionate stratification, just make sure to adjust <code>samplesz</code> accordingly.</p>
</div>
<div id="cluster-sampling" class="section level2">
<h2>Cluster Sampling</h2>
<p>Clustering is fairly similar except this time we sample <em>from</em> the grouped table rather than within it.</p>
<pre class="r"><code>universe %&gt;% 
  # group the population by cluster
  group_nest(ea) %&gt;% 
  # draw the desired number of clusters
  sample_n(size = 10) %&gt;% 
  # and revert to a form that we can work with.
  unnest(data)</code></pre>
<pre><code>## # A tibble: 1,672 x 5
##    ea    strata         hh    safety    pcexp
##    &lt;chr&gt; &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 634   Host community 62829 Not safe  9626.
##  2 634   Host community 62830 Not safe  8277.
##  3 634   Host community 62831 Not safe 12510.
##  4 634   Host community 62832 Not safe 11408.
##  5 634   Host community 62833 Not safe 11559.
##  6 634   Host community 62834 Not safe  9817.
##  7 634   Host community 62835 Safe     10844.
##  8 634   Host community 62836 Not safe 13357.
##  9 634   Host community 62837 Safe     10284.
## 10 634   Host community 62838 Not safe 13240.
## # … with 1,662 more rows</code></pre>
<p>We could have also passed any measure of size to <code>sample_n()</code>’s <code>weight</code> argument for unequal probability sampling.</p>
</div>
<div id="multi-stage-sampling" class="section level2">
<h2>Multi-stage Sampling</h2>
<p>Armed with the basics, we can compose the pieces to construct arbitrarily complex designs as we wish.</p>
<p>Here, for example, is the familiar two-stage design with probability proportional to size selection at first stage and equal sample allocation across strata:</p>
<pre class="r"><code>mssample &lt;- function(universe) {
  samplesz &lt;- 1000
  strata_cnt &lt;- length(unique(universe$strata))
  hh_per_cluster &lt;- 10
  clusters_per_stratum &lt;- samplesz/hh_per_cluster/strata_cnt
  
  msdata &lt;- 
    universe %&gt;% 
    group_nest(strata, ea) %&gt;% 
    rowwise() %&gt;% 
    mutate(psusz = nrow(data)) %&gt;% 
    group_nest(strata) %&gt;% 
    rowwise() %&gt;% 
    mutate(stratasz = sum(data$psusz))

  stage1 &lt;- 
    msdata %&gt;% 
    rowwise() %&gt;% 
    mutate(sample = list(tibble(slice_sample(data, n = clusters_per_stratum, weight_by = data[[1]]$psusz)))) %&gt;% 
    select(-data) %&gt;% 
    unnest(sample)
    
  stage2 &lt;- 
    stage1 %&gt;% 
    rowwise() %&gt;% 
    mutate(sample = list(sample_n(data, size = hh_per_cluster))) %&gt;% 
    select(-data) %&gt;% 
    unnest(sample)
  
  s &lt;- 
    stage2 %&gt;% 
    mutate(
      p1 = psusz/stratasz, p2 = hh_per_cluster/psusz,
      p = p1 * p2,
      wt = 1/p, wt = wt/sum(wt) * length(wt)) %&gt;% 
    select(-stratasz, -psusz, -p1, -p2, -p)
  
  s
}

(s &lt;- mssample(universe))</code></pre>
<pre><code>## # A tibble: 1,000 x 6
##    strata         ea    hh    safety    pcexp    wt
##    &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
##  1 Host community 039   03884 Not safe 10981.  1.33
##  2 Host community 039   03852 Not safe  7743.  1.33
##  3 Host community 039   03909 Not safe  9167.  1.33
##  4 Host community 039   03886 Safe     10630.  1.33
##  5 Host community 039   03811 Safe     12105.  1.33
##  6 Host community 039   03802 Not safe  9659.  1.33
##  7 Host community 039   03923 Not safe  9134.  1.33
##  8 Host community 039   03794 Not safe 11369.  1.33
##  9 Host community 039   03835 Safe      8881.  1.33
## 10 Host community 039   03915 Safe     10969.  1.33
## # … with 990 more rows</code></pre>
<p>We’ve stored this design and its output so we can reuse them in the second half of this tutorial. Also note that we’ve added normalized weights to our sample in the last step so that we could draw valid inferences from our sample.</p>
</div>
</div>
<div id="estimation" class="section level1">
<h1>Estimation</h1>
<p>We’ll now shift our attention to estimation.</p>
<div id="point-estimation" class="section level2">
<h2>Point Estimation</h2>
<p>Point estimation refers to the calculation of sums, averages, ratios, etc… from sample data.</p>
<p>For estimates involving categorical variables, dplyr’s <code>count()</code> already supports a <code>wt</code> argument for weighted calculations.</p>
<pre class="r"><code>s %&gt;% count(strata, safety, wt = wt) %&gt;% group_by(strata) %&gt;% mutate(p = n/sum(n)*100)</code></pre>
<pre><code>## # A tibble: 4 x 4
## # Groups:   strata [2]
##   strata         safety       n     p
##   &lt;chr&gt;          &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1 Host community Not safe  186.  28. 
## 2 Host community Safe      478.  72  
## 3 Refugees       Not safe  216.  64.2
## 4 Refugees       Safe      121.  35.8</code></pre>
<p>Which is basically what we had specified when constructing our synthetic data: 70% of the host community feel safe in their neighborhoods whereas only 40% of the refugee population share the sentiment.</p>
<p>Actually, since our sample is self-weighting within each strata, the results would have come back the same with or without weights. Let’s look at the overall totals to see why weights are needed:</p>
<pre class="r"><code>left_join(
  s %&gt;% count(safety, wt = wt, name = &quot;n.weighted&quot;) %&gt;% mutate(p.weighted = n.weighted/sum(n.weighted)*100),
  s %&gt;% count(safety, name = &quot;n.unweighted&quot;) %&gt;% mutate(p.unweighted = n.unweighted/sum(n.unweighted)*100))</code></pre>
<pre><code>## # A tibble: 2 x 5
##   safety   n.weighted p.weighted n.unweighted p.unweighted
##   &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;        &lt;int&gt;        &lt;dbl&gt;
## 1 Not safe       402.       40.2          461         46.1
## 2 Safe           598.       59.8          539         53.9</code></pre>
<p>Now compare that to the census:</p>
<pre class="r"><code>universe %&gt;% count(safety) %&gt;% mutate(p = n/sum(n)*100)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   safety       n     p
##   &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt;
## 1 Not safe 40673  40.7
## 2 Safe     59311  59.3</code></pre>
<p>And you could see that our weighted estimates are more in line with what we should have gotten.</p>
<p>What about point estimates involved continuous variables? Unfortunately there’s no convenience function similar to <code>count()</code> for those. That means we’ll have to fall back on the usual group+summarize workflow:</p>
<pre class="r"><code>s %&gt;% group_by(strata) %&gt;% summarize(pcexp = weighted.mean(pcexp, wt))</code></pre>
<pre><code>## # A tibble: 2 x 2
##   strata         pcexp
##   &lt;chr&gt;          &lt;dbl&gt;
## 1 Host community 9947.
## 2 Refugees       5025.</code></pre>
<p>Ground-truth:</p>
<pre class="r"><code>universe %&gt;% group_by(strata) %&gt;% summarize(pcexp = mean(pcexp))</code></pre>
<pre><code>## # A tibble: 2 x 2
##   strata         pcexp
##   &lt;chr&gt;          &lt;dbl&gt;
## 1 Host community 9977.
## 2 Refugees       4979.</code></pre>
<p>Close enough, with slight deviations because of sampling error… which brings us to the last part of this tutorial.</p>
</div>
<div id="variance-estimation" class="section level2">
<h2>Variance Estimation</h2>
<p>When producing estimates from sample data, we’re normally interested in more than just the point estimates. We also want to know how accurate our estimates are. This is the domain of variance estimation.</p>
<p>Let’s start by producing the <em>actual</em> sampling distribution of our mean per-capita expenditure statistic. We can do that since we’re working with simulated data. It wouldn’t otherwise be possible in the real world.</p>
<pre class="r"><code>samplingdist &lt;- 
  map_dfr(
    1:500,
    function(x) {
      mssample(universe) %&gt;% 
        { 
          bind_rows(
            group_by(., strata) %&gt;% summarize(pcexp = weighted.mean(pcexp, wt)),
            group_by(., strata = &quot;Everyone&quot;) %&gt;% summarize(pcexp = weighted.mean(pcexp, wt)))
        }
    })</code></pre>
<p>Which tells us that our point estimates and standard errors should be:</p>
<pre class="r"><code>(est_universe &lt;- samplingdist %&gt;% group_by(strata) %&gt;% summarize(est = mean(pcexp), se = sd(pcexp)))</code></pre>
<pre><code>## # A tibble: 3 x 3
##   strata           est    se
##   &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt;
## 1 Everyone       8295.  66.1
## 2 Host community 9979.  93.5
## 3 Refugees       4976.  60.0</code></pre>
<p>We had gotten to those point estimates in the previous section. Our job now is to try to reproduce the standard error <code>se</code> from nothing but the sample data.</p>
<p>Most software approaches variance estimation using analytical methods grounded in some smart mathematical approximations. We’ll take a more (brute-force) computational approach based on the bootstrap here. The bootstrap, for those not familiar with it, is the idea of resampling with replacement from sample data to approximate the sampling distribution of the target statistic. See section 2 of <a href="https://arxiv.org/abs/1411.5279">this article</a> for more details on the how and why of bootstrapping.</p>
<p>We could implement the bootstrap ourselves using <code>rerun()</code> and <code>sample_n()</code> with <code>replace = TRUE</code> but instead we’re going to pull in <a href="https://www.tidymodels.org/">tidymodels</a> and use <code>rsample::bootstraps()</code>. It’s more convenient, idiomatic, and you’ll probably have tidymodels loaded in your workspace anyway if you’re planning on running any models on your survey data.</p>
<pre class="r"><code>library(tidymodels)

b &lt;- s %&gt;% group_nest(strata, ea) %&gt;% bootstraps(times = 500, strata = strata)

b &lt;- 
  b %&gt;% 
  rowwise() %&gt;% 
  mutate(
    stats = 
      analysis(splits) %&gt;% 
      unnest(data) %&gt;% 
      { 
        bind_rows(
          group_by(., strata) %&gt;% summarize(pcexp = weighted.mean(pcexp, wt)),
          group_by(., strata = &quot;Everyone&quot;) %&gt;% summarize(pcexp = weighted.mean(pcexp, wt)))
      } %&gt;% 
      list()
  )

(est_sample &lt;- 
  b %&gt;% 
  select(stats) %&gt;% 
  unnest(stats) %&gt;% 
  group_by(strata) %&gt;% 
  summarize(est = mean(pcexp), se = sd(pcexp)))</code></pre>
<pre><code>## # A tibble: 3 x 3
##   strata           est    se
##   &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt;
## 1 Everyone       8290.  59.7
## 2 Host community 9947.  85.1
## 3 Refugees       5024.  56.9</code></pre>
<p>The key thing to keep in mind is that the bootstrap sample should resemble the original sample in the way it is drawn. Meaning, if we had drawn clusters from within strata in the original sample, then we should resample clusters within strata for the bootstrap.</p>
<p>Let’s see how our estimates stack up against the actual values we had calculated earlier.</p>
<pre class="r"><code>bind_rows(&quot;sampling distribution&quot; = est_universe, &quot;bootstrap&quot; = est_sample, .id = &quot;src&quot;) %&gt;% 
  ggplot(aes(x = est, y = strata, xmin = est - 2*se, xmax = est + 2*se, color = src)) +
  geom_point(position = position_dodge(-.5), size = 3) +
  geom_errorbarh(position = position_dodge(-.5), height = .5) +
  theme_minimal() +
  labs(x = NULL, y = NULL, color = NULL,
       title = &quot;Estimated per-capita expenditures&quot;,
       subtitle = &quot;Mean &amp; 95% confidence interval&quot;)</code></pre>
<p><img src="/post/tidysampling_files/figure-html/varest_plot-1.png" width="672" /></p>
<p>Confirming that our estimates line up with what they should be.</p>
</div>
</div>

    </div>
      

  </div>

  <footer>
    <ul class="stats">
  <li class="categories">
    <ul>
        
            
            
                <i class="fa fa-folder"></i>
                
                
                <li><a class="article-category-link" href="/categories/sampling">Sampling</a></li>
                
                
                <li><a class="article-category-link" href="/categories/survey">Survey</a></li>
                
            
        
    </ul>
  </li>
  <li class="tags">
    <ul>
        
            
            
                <i class="fa fa-tags"></i>
                
                
                <li><a class="article-category-link" href="/tags/unhcr">UNHCR</a></li>
                
                
                <li><a class="article-category-link" href="/tags/hisham-galal">Hisham-Galal</a></li>
                
            
        
    </ul>
  </li>
</ul>

    
 
  <script>
  $(document).ready(function () {
    window.initializeCodeFolding("show" === "hide");
  });
  </script>
  
  <script>
    window.initializeCodeFolding = function(show) {

  
  $("#rmd-show-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  
  var currentIndex = 1;

  
  var rCodeBlocks = $('');
  rCodeBlocks.each(function() {

    
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}

  </script>
  


  </footer>
  

<div class="related-articles">
<h3>Related articles</h3>
<ul>
	<li>
	
	  <ul>
      <article class="mini-post">
        <header>
          <h3>
            <a href="/post/geosampling/">Using Gridded Population Data for Household Survey Sampling</a>
          </h3>
          
          <time class="published" datetime='2020-04-14 00:00:00 &#43;0000 UTC'>
          April 14, 2020</time>
        </header>
        

      </article>
  	</ul>
	
	  <ul>
      <article class="mini-post">
        <header>
          <h3>
            <a href="/post/analytic-hierachy-process/">Using Analytic Hierarchy Process to weight vulnerability scorecard</a>
          </h3>
          
          <time class="published" datetime='2020-02-23 00:00:00 &#43;0000 UTC'>
          February 23, 2020</time>
        </header>
        

      </article>
  	</ul>
	
	  <ul>
      <article class="mini-post">
        <header>
          <h3>
            <a href="/post/quick-tips-for-visualising-data/">Quick tips for visualising data (with R)</a>
          </h3>
          
          <time class="published" datetime='2020-04-02 00:00:00 &#43;0000 UTC'>
          April 2, 2020</time>
        </header>
        

      </article>
  	</ul>
	
	</li>	
</ul>
</div>


</article>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-humanitarian-user-group-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>


<ul class="actions pagination">
    
        <li><a href="/post/geosampling/"
                class="button big previous">Using Gridded Population Data for Household Survey Sampling</a></li>
    

    
        <li><a href="/post/anonymisation/"
                class="button big next">Anonymisation: Intrusion scenario and risk threshold</a></li>
    
</ul>


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/' class="logo"><img src="/images/avatar.png" alt="HumanitaRian useR Group" /></a>
      
    
    
      <header>
        <h2></h2>
        <p>~ Science is 'show me' - not 'trust me' ~</p>
      </header>
    
    
  </section>

  
  <section class="recent-posts">
    <div class="mini-posts">
      <header>
        <h3>Recent posts</h3>
      </header>
      <div class="posts-container">
        

        
          
        

        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/anonymisation/">Anonymisation: Intrusion scenario and risk threshold</a>
              </h3>
              
              <time class="published" datetime='2020-06-25 00:00:00 &#43;0000 UTC'>
              June 25, 2020</time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/">Post</a>
              </h3>
              
              <time class="published" datetime='2020-06-25 00:00:00 &#43;0000 UTC'>
              June 25, 2020</time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/tidysampling/">Working with Survey Samples in the Tidyverse</a>
              </h3>
              
              <time class="published" datetime='2020-05-29 00:00:00 &#43;0000 UTC'>
              May 29, 2020</time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/geosampling/">Using Gridded Population Data for Household Survey Sampling</a>
              </h3>
              
              <time class="published" datetime='2020-04-14 00:00:00 &#43;0000 UTC'>
              April 14, 2020</time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/quick-tips-for-visualising-data/">Quick tips for visualising data (with R)</a>
              </h3>
              
              <time class="published" datetime='2020-04-02 00:00:00 &#43;0000 UTC'>
              April 2, 2020</time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/conjoint-analysis/">Conjoint analysis: modeling judgement to calibrate vulnerability scoring</a>
              </h3>
              
              <time class="published" datetime='2020-03-19 00:00:00 &#43;0000 UTC'>
              March 19, 2020</time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/analytic-hierachy-process/">Using Analytic Hierarchy Process to weight vulnerability scorecard</a>
              </h3>
              
              <time class="published" datetime='2020-02-23 00:00:00 &#43;0000 UTC'>
              February 23, 2020</time>
            </header>
            

          </article>
        
      </div>

      
        <a href=
          
            /post/
          
        class="button">See more</a>
      
    </div>
  </section>

  
  
  


  
  
    <section id="mini-bio">
      <h3>about</h3>
      <p>The humanitarian data analysis professional community shall work towards using a common and open language to build interoperable and transparent analysis standards for joint needs assessments and to obtain maximum value for any data collected.</p>
      <a href="/about" class="button">learn more</a>
    </section>
  

  
  <section id="footer">
    
    <p class="copyright">
      
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.
      .
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    
    <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
    

    
      
    
    
    
    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
      <script src="/js/backToTop.js"></script>
    
    

    
      
        
      
    
    
    
    <script>hljs.initHighlightingOnLoad();</script>
      <script src="/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


      
          
    
      <script src="/js/collapse.js"></script>
      <script src="/js/dropdown.js"></script>
      <script src="/js/transition.js"></script>
    
    
  </body>
</html>

